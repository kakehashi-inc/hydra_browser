# システム仕様

## 1. 概要

Hydra Browserは、複数の役割・デバイスサイズで同一システムを同時テストするための開発者向けブラウザです。異なるユーザー役割に対して独立したセッション管理を可能にし、様々なデバイスビューポートのシミュレーションをサポートします。

### 1.1 主な機能

- **マルチペインブラウジング**: 複数のブラウザペインを同時に表示
- **デバイスエミュレーション**: 様々なデバイス解像度をシミュレーション
- **セッション分離**: 26種類の独立したセッションパーティション（A-Z）
- **ワークスペース管理**: ペイン構成の保存・復元
- **ダウンロード管理**: 組み込みダウンロードマネージャー
- **コンソール監視**: コンソールの警告/エラーを視覚的に表示

### 1.2 技術スタック

- **フレームワーク**: Electron
- **レンダリングエンジン**: Chromium（WebContentsView経由）
- **フロントエンド**: React, TypeScript, MUI v7
- **状態管理**: Zustand
- **国際化**: i18next

## 2. アーキテクチャ

### 2.1 プロセスアーキテクチャ

```
メインプロセス
├── StorageService      - データ永続化
├── SessionService      - セッション/パーティション管理
├── PaneService         - WebContentsView管理
├── WorkspaceService    - ワークスペース管理
├── DownloadService     - ダウンロード処理
└── IPC Handlers        - レンダラーとの通信

レンダラープロセス
├── App                 - メインアプリケーションコンポーネント
├── Stores (Zustand)    - UI状態管理
├── Components          - React UIコンポーネント
└── IPC Bridge          - メインとの通信
```

### 2.2 データフロー

1. ユーザーがUI（レンダラー）を操作
2. アクションがIPC経由でメインプロセスへ送信
3. メインプロセスが状態を更新/アクションを実行
4. メインプロセスがレンダラーへ更新イベントを送信
5. レンダラーがZustandストア経由でUIを更新

## 3. 機能仕様

### 3.1 ペイン管理

#### ペイン作成
- ユーザーが「ペイン追加」ボタンをクリック
- 解像度、スケール、パーティションオプションを含むダイアログが開く
- 確定時、メインプロセスで新しいWebContentsViewが作成される
- ペインがアクティブワークスペースに追加されレンダリングされる

#### ペインプロパティ
- **解像度**: ビューポートサイズ（例: iPhone SE用 375x667）
- **スケール**: 表示スケール（10-200%）
- **パーティション**: セッション識別子（A-Z）

#### デバイスエミュレーション
```javascript
webContents.enableDeviceEmulation({
    screenPosition: 'mobile',
    screenSize: { width, height },
    viewSize: { width, height },
    deviceScaleFactor: 1,
    scale: scaleFactor
});
```

#### 新規ウィンドウ処理
- Shift+クリック、Ctrl+クリック、中クリック、target="_blank"
- ソースと同じプロパティで新しいペインを作成
- ソースペインの直後に挿入

### 3.2 セッションパーティション

#### 実装
```javascript
session.fromPartition('persist:partition-X')
```

#### 分離範囲
| データ種別 | 分離/共有 |
|-----------|----------|
| Cookie | パーティションごとに分離 |
| localStorage | パーティションごとに分離 |
| sessionStorage | パーティションごとに分離 |
| IndexedDB | パーティションごとに分離 |
| オートコンプリート | 全パーティション共有 |
| パスワード | 全パーティション共有 |

### 3.3 ワークスペース管理

#### 操作
- **新規作成**: 空のワークスペースを作成
- **切り替え**: アクティブワークスペースを変更、ペインを読み込み
- **リネーム**: ワークスペース名を変更
- **削除**: ワークスペースを削除（最後の場合は自動作成）

#### 自動保存
- ペインの変更は自動的にアクティブワークスペースに保存
- 保存タイミング: ペイン追加/削除、設定変更、ナビゲーション

### 3.4 コンソール状態監視

#### 検出
```javascript
webContents.on('console-message', (event, level) => {
    // level: 0=verbose, 1=info, 2=warning, 3=error
});
```

#### 視覚的表示
- **通常**: デフォルトのタイトルバー色
- **Warning検出**: 黄色系のタイトルバー
- **Error検出**: 赤系のタイトルバー（最優先）

#### リセット
- メインフレームのナビゲーション時に通常色へリセット

### 3.5 ダウンロード管理

#### フロー
1. セッションがダウンロードリクエストをキャプチャ
2. 保存パスを決定（重複時は自動リネーム）
3. 進捗を追跡しレンダラーへ送信
4. 完了/失敗を通知

#### 機能
- 保存ダイアログなし（自動保存）
- ツールバーに進捗インジケーター
- ファイル一覧付きダウンロードパネル
- ファイルを開く/フォルダを開くアクション

## 4. データ永続化

### 4.1 保存場所

| OS | パス |
|----|------|
| Windows | %APPDATA%\Hydra\ |
| macOS | ~/Library/Application Support/Hydra/ |
| Linux | $XDG_CONFIG_HOME/Hydra/ または ~/.config/Hydra/ |

### 4.2 ファイル

| ファイル | 内容 |
|----------|------|
| workspaces.json | ワークスペース構成 |
| window-state.json | ウィンドウ位置/サイズ |
| settings.json | アプリケーション設定 |

### 4.3 ウィンドウ状態

- アプリケーション終了時に保存
- 起動時に復元
- 最大化状態は個別に処理

## 5. IPC通信

### 5.1 チャンネル

#### App
- `app:getInfo` - アプリ情報を取得
- `app:setTheme` - テーマを設定
- `app:setLanguage` - 言語を設定

#### Pane
- `pane:create` - 新規ペインを作成
- `pane:close` - ペインを閉じる
- `pane:update` - ペイン設定を更新
- `pane:navigate` - URLへナビゲート
- `pane:toggleDevTools` - DevToolsを開閉

#### Workspace
- `workspace:create` - ワークスペースを作成
- `workspace:delete` - ワークスペースを削除
- `workspace:rename` - ワークスペースをリネーム
- `workspace:switch` - ワークスペースを切り替え

#### Download
- `download:getAll` - 全ダウンロードを取得
- `download:cancel` - ダウンロードをキャンセル
- `download:openFile` - ダウンロードファイルを開く
- `download:openFolder` - 保存フォルダを開く

### 5.2 イベント（メイン -> レンダラー）

- `pane:stateUpdated` - ペイン状態が変更された
- `pane:focusChanged` - フォーカスが変更された
- `pane:created` - 新規ペインが作成された
- `pane:closed` - ペインが閉じられた
- `download:started` - ダウンロードが開始された
- `download:progress` - ダウンロード進捗
- `download:completed` - ダウンロードが完了した
- `download:failed` - ダウンロードが失敗した

## 6. 解像度プリセット

| カテゴリ | デバイス | 解像度 |
|----------|----------|--------|
| Mobile | iPhone SE | 375x667 |
| Mobile | iPhone 14 | 390x844 |
| Mobile | iPhone 14 Pro Max | 430x932 |
| Mobile | Pixel 7 | 412x915 |
| Mobile | Galaxy S20 | 360x800 |
| Tablet | iPad Mini | 768x1024 |
| Tablet | iPad Air | 820x1180 |
| Tablet | iPad Pro 12.9 | 1024x1366 |
| Desktop | Laptop | 1366x768 |
| Desktop | Desktop | 1920x1080 |
| Desktop | Desktop Large | 2560x1440 |

## 7. 対応プラットフォーム

| OS | アーキテクチャ |
|----|--------------|
| Windows | x64, arm64 |
| macOS | x64, arm64 |
| Linux | x64, arm64 |
