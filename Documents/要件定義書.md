# Hydra Browser 要件定義書

## 1. 概要

### 1.1 プロジェクト情報
- **正式名称**: Hydra Browser
- **略称**: Hydra
- **目的**: 複数の役割・デバイスサイズで同一システムを同時テストするための開発者向けブラウザ

### 1.2 背景
同一データベースで動作するシステムにおいて、異なる部署・役割のユーザー操作を同時にテストする必要がある。各役割は独立したセッション管理が必要であり、かつ異なるデバイスサイズでの表示確認も同時に行いたい。

### 1.3 技術ベース
- **フレームワーク**: Electron
- **レンダリングエンジン**: Chromium
- **View API**: WebContentsView

### 1.4 対応プラットフォーム

| OS      | アーキテクチャ    |
| ------- | ---------- |
| Windows | x64, arm64 |
| macOS   | x64, arm64 |
| Linux   | x64, arm64 |

---

## 2. 機能要件

### 2.1 ペイン管理

#### 2.1.1 ペインの追加
- ツールバーから新規ペインを追加
- 追加時に以下を設定:
  - **解像度**: プリセットから選択、またはカスタム入力
  - **表示スケール**: パーセント指定（初期値、後からドラッグで変更可）
  - **パーティション**: A-Z から選択

#### 2.1.2 解像度プリセット

| カテゴリ | デバイス名 | 解像度 |
|----------|------------|--------|
| Mobile | iPhone SE | 375x667 |
| Mobile | iPhone 14 | 390x844 |
| Mobile | iPhone 14 Pro Max | 430x932 |
| Mobile | Pixel 7 | 412x915 |
| Mobile | Galaxy S20 | 360x800 |
| Tablet | iPad Mini | 768x1024 |
| Tablet | iPad Air | 820x1180 |
| Tablet | iPad Pro 12.9 | 1024x1366 |
| Desktop | Laptop | 1366x768 |
| Desktop | Desktop | 1920x1080 |
| Desktop | Desktop Large | 2560x1440 |
| - | カスタム | 任意入力 |

※プリセットはプログラム内の定数として定義し、容易に変更可能な設計とする

#### 2.1.3 解像度と表示スケールの関係
- ページには設定した解像度を認識させる
- 実際の表示サイズは `解像度 × 表示スケール`
- 例: 解像度 1024x600、表示スケール 50% → ページは 1024x600 と認識、実表示は 512x300

#### 2.1.4 表示スケールの変更
- 各ペインの右下隅にリサイズハンドルを配置
- ドラッグで表示スケールを変更
- **縦横比は維持**（解像度は固定、表示サイズのみ変更）

#### 2.1.5 ペインのタイトルバー構造

```
+-------------------------------------------+
| [ページタイトル...]    [DevTools] [⚙] [×] |
+-------------------------------------------+
```

| 要素 | 仕様 |
|------|------|
| 幅 | ペインの実表示幅を超えない |
| ページタイトル | 可変幅、溢れた場合は省略表示（...） |
| DevToolsアイコン | 小サイズ、固定幅、優先表示 |
| 設定アイコン | 小サイズ、固定幅、優先表示 |
| 閉じるアイコン | 小サイズ、固定幅、優先表示 |

- アイコンは右端に固定配置
- タイトルテキストは残りの幅で表示、溢れは `text-overflow: ellipsis`

#### 2.1.6 タイトルバーのコンソール状態表示

**色による状態表示**

| 状態 | タイトルバー背景色 |
|------|-------------------|
| 通常 | デフォルト色 |
| Warning検出 | 黄色系 |
| Error検出 | 赤系 |

**優先順位**
- Error > Warning > 通常
- Error検出後にWarningが発生してもError色を維持

**リセット条件**
- ページ移動（ナビゲーション）時に通常色へリセット

#### 2.1.7 DevTools
- タイトルバーのDevToolsアイコンをクリックで該当ペインのDevToolsを開閉
- DevToolsは別ウィンドウで表示

#### 2.1.8 ペインプロパティ変更（設定アイコン押下時）
- ダイアログまたはポップオーバーで以下を変更可能:
  - 解像度（プリセット選択 or カスタム）
  - 表示スケール（数値入力）
  - パーティション（A-Z）

#### 2.1.9 レイアウト
- flexbox による自動配置（flex-wrap）
- 各ペインの実表示サイズに応じて折り返し

#### 2.1.10 新規タブ/ウィンドウ要求の処理

**対象となる操作**
- Shift + クリック
- Ctrl + クリック
- 中クリック（ホイールクリック）
- `target="_blank"` リンクのクリック
- `window.open()` の呼び出し

**動作仕様**

| 項目 | 内容 |
|------|------|
| 新ペインの挿入位置 | 操作元ペインの直後 |
| プロパティ継承 | 解像度・表示スケール・パーティションをコピー |
| 表示URL | リンク先URL |
| アクティブペイン | 新ペインに移動 |

**処理フロー**

```
1. ユーザーが新規タブ操作を実行
2. 操作元ペインのプロパティを取得
   - 解像度
   - 表示スケール
   - パーティション
3. 操作元ペインの直後に新ペインを作成
4. 同一プロパティで初期化
5. リンク先URLをロード
6. フォーカスを新ペインに移動
7. URLバーを新ペインのURLに更新
8. ワークスペースに自動保存
```

### 2.2 URLバー

#### 2.2.1 構成
- グローバルURLバー（単一）をツールバーに配置

#### 2.2.2 動作
- フォーカス中のペインのURLを表示
- 編集可能
- Enter キーでフォーカス中ペインをナビゲート

### 2.3 パーティション（セッション管理）

#### 2.3.1 パーティション選択
- A-Z の26種類から選択

#### 2.3.2 動作仕様

| 条件 | Cookie | TCPコネクション |
|------|--------|-----------------|
| 同一パーティション | 共有 | 別 |
| 異なるパーティション | 分離 | 別 |

#### 2.3.3 パーティション分離の範囲

| データ種別 | 分離/共有 |
|-----------|----------|
| Cookie | パーティションごとに分離 |
| localStorage | パーティションごとに分離 |
| sessionStorage | パーティションごとに分離 |
| IndexedDB | パーティションごとに分離 |
| オートコンプリート | 全パーティション共有 |
| パスワード保存 | 全パーティション共有 |
| フォーム入力履歴 | 全パーティション共有 |

### 2.4 ワークスペース

#### 2.4.1 UI配置

```
[新規] [ワークスペース ▼] [リネーム] [削除]
```

#### 2.4.2 操作

| 操作 | 動作 |
|------|------|
| 新規 | 名前入力ダイアログ → 空のワークスペース作成 → 切り替え |
| ドロップダウン | ワークスペース一覧から選択 → 切り替え |
| リネーム | 名前入力ダイアログ → アクティブワークスペースの名前変更 |
| 削除 | 確認ダイアログ → 削除実行 |

#### 2.4.3 保存対象（ペインごと）
- URL
- 解像度
- 表示スケール
- パーティション

#### 2.4.4 保存対象外
- スクロール位置
- フォーム入力内容
- ページ内状態

#### 2.4.5 自動保存
- ペインの追加・削除・設定変更は即時アクティブワークスペースに反映

#### 2.4.6 初回起動
- 「ワークスペース1」が自動作成される

#### 2.4.7 最後のワークスペース削除時
- 削除後、新規「ワークスペース1」が自動生成される

### 2.5 ウィンドウ状態管理

#### 2.5.1 保存タイミング
- アプリケーション終了時

#### 2.5.2 保存内容

| 状態 | 保存内容 |
|------|----------|
| 最大化 | 「最大化」フラグ |
| 通常サイズ | ウィンドウ位置（x, y）、サイズ（幅, 高さ） |
| 最小化中に終了 | 復元して元の状態を判定し保存 |

#### 2.5.3 起動時
- 前回終了時のウィンドウ状態を復元
- 前回のアクティブワークスペースを復元

### 2.6 ダウンロード管理

#### 2.6.1 ダウンロード処理
- ページからのダウンロード要求をトラップ
- ダイアログなしで自動保存

#### 2.6.2 保存先
- **デフォルト**: ユーザーホームディレクトリの `Downloads` フォルダ
- 設定画面から変更可能

#### 2.6.3 ツールバーアイコン

| 状態 | アイコン表示 |
|------|--------------|
| ダウンロードなし | 通常アイコン（グレーなど） |
| ダウンロード中 | アニメーションまたは色変化 |
| 完了あり（未確認） | バッジ表示など |

#### 2.6.4 ダウンロードパネル（アイコンクリック時）
- ファイル一覧表示
- 各ファイルの進捗バー
- キャンセルボタン
- 完了後: ファイルを開く / フォルダを開く
- 一覧クリア機能

#### 2.6.5 動作仕様（Chrome準拠）
- 同名ファイルは自動リネーム（例: file(1).pdf）
- ダウンロード失敗時はエラー表示
- 一時ファイル → 完了後に正式ファイル名へリネーム

---

## 3. UI構成

### 3.1 ツールバー

```
[ペイン追加] [URLバー                    ] [ダウンロード] [新規] [ワークスペース ▼] [リネーム] [削除] [設定]
```

### 3.2 ペイン追加ダイアログ
- 解像度選択（プリセット or カスタム入力）
- 表示スケール入力（%）
- パーティション選択（A-Z ドロップダウン）

### 3.3 メインエリア
- flexbox コンテナ
- 各ペインが実表示サイズで配置・折り返し

### 3.4 各ペイン構造

```
+--------------------------------------+
| [タイトル...]     [DevTools] [⚙] [×] |  ← タイトルバー（幅 = 実表示幅、コンソール状態で背景色変化）
+--------------------------------------+
|                                      |
|         WebContentsView              |  ← ブラウザ表示
|                                      |
|                                  [◢] |  ← リサイズハンドル（右下）
+--------------------------------------+
```

### 3.5 ペインプロパティ変更ダイアログ/ポップオーバー
- 解像度選択（プリセット or カスタム入力）
- 表示スケール入力（%）
- パーティション選択（A-Z ドロップダウン）

### 3.6 設定画面
- ダウンロード保存先: フォルダ選択

---

## 4. 技術仕様

### 4.1 デバイスエミュレーション
- `webContents.enableDeviceEmulation()` を使用
- deviceScaleFactor と viewport で解像度・表示スケールを制御

### 4.2 セッション分離
- `session.fromPartition('persist:partition-X')` を使用
- X は A-Z のパーティション識別子

### 4.3 データ永続化

#### 4.3.1 保存先

| OS | パス | 環境変数 |
|----|------|----------|
| Windows | `%APPDATA%\Hydra\` | `APPDATA` |
| macOS | `~/Library/Application Support/Hydra/` | `HOME` |
| Linux | `$XDG_CONFIG_HOME/Hydra/` または `~/.config/Hydra/` | `XDG_CONFIG_HOME` |

#### 4.3.2 パス解決の優先順位

| OS | 処理 |
|----|------|
| Windows | `APPDATA` 環境変数を取得、未設定時は `USERPROFILE\AppData\Roaming` |
| macOS | `HOME` 環境変数を取得し `Library/Application Support` を付加 |
| Linux | `XDG_CONFIG_HOME` 環境変数を取得、未設定時は `HOME/.config` |

#### 4.3.3 保存ファイル

| ファイル | 内容 |
|----------|------|
| `workspaces.json` | ワークスペース一覧・各ペイン設定 |
| `window-state.json` | ウィンドウ位置・サイズ・状態 |
| `settings.json` | アプリ設定（ダウンロード先など） |

### 4.4 解像度プリセット定義
- プログラム内の定数配列として定義
- カテゴリ・デバイス名・幅・高さを持つオブジェクトの配列
- ソースコード修正で容易に追加・変更可能な構造とする

### 4.5 新規ウィンドウ要求のハンドリング

```javascript
// WebContentsのnew-window / window.openイベントをハンドル
webContents.setWindowOpenHandler(({ url }) => {
  // 新ペイン作成処理を実行
  // return { action: 'deny' } でElectronデフォルトの新ウィンドウを抑制
});
```

### 4.6 ダウンロードハンドリング

```javascript
// セッションごとにダウンロードイベントをハンドル
session.on('will-download', (event, item, webContents) => {
  // 保存先を設定
  item.setSavePath(path.join(downloadDir, item.getFilename()));
  
  // 進捗監視
  item.on('updated', (event, state) => {
    // UIに進捗を反映
  });
  
  // 完了/キャンセル
  item.on('done', (event, state) => {
    // 完了処理
  });
});
```

### 4.7 DevTools

```javascript
// DevToolsを別ウィンドウで開閉
webContents.openDevTools({ mode: 'detach' });
webContents.closeDevTools();
```

### 4.8 コンソール監視

```javascript
// コンソールメッセージの監視
webContents.on('console-message', (event, level, message, line, sourceId) => {
  // level: 0=verbose, 1=info, 2=warning, 3=error
  if (level === 2) {
    // Warning検出 - 現在Errorでなければ黄色系に変更
  } else if (level === 3) {
    // Error検出 - 赤系に変更（最優先）
  }
});

// ページ移動時にリセット
webContents.on('did-start-navigation', (event, url, isInPlace, isMainFrame) => {
  if (isMainFrame) {
    // タイトルバー色をリセット
  }
});
```

### 4.9 オートコンプリート・パスワード管理

- オートコンプリート・パスワードデータは共通ストレージに保存
- Cookieとセッションのみパーティション分離
- 保存先: `[データ永続化パス]/autofill/`
- 設定画面でクリアするボタンを設置（クリアした場合は削除しながらアプリを再起動）

---

## 5. 制約事項

- パーティションは A-Z の 26 種類固定
- ページ内状態（スクロール、フォーム入力等）は保存対象外
